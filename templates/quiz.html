{% extends "base.html" %}

{% block title %}Quiz - {{ subject.name }}{% endblock %}

{% block content %}
<div id="quiz-app" class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-emerald-50/50">

    <!-- Header -->
    <header class="sticky top-0 z-40 backdrop-blur-lg bg-white/80 border-b border-gray-100">
        <div class="max-w-lg mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="confirmExit()" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-base font-bold text-gray-900">{{ subject.name }} Quiz</h1>
                        <p class="text-xs text-gray-500">{{ date_display }}</p>
                    </div>
                </div>
                <!-- Progress -->
                <div class="text-right">
                    <p class="text-xs text-gray-500">Question</p>
                    <p class="font-bold text-emerald-600"><span id="current-num">1</span>/{{ questions|length }}</p>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="mt-3 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar"
                    class="h-full bg-gradient-to-r from-emerald-400 to-emerald-500 rounded-full transition-all duration-300"
                    style="width: 2%"></div>
            </div>
        </div>
    </header>

    <!-- Question Container -->
    <main class="max-w-lg mx-auto px-4 py-6 pb-32">
        <div id="question-container">
            <!-- Question will be rendered here by JS -->
        </div>
    </main>

    <!-- Bottom Actions -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 z-50">
        <div class="max-w-lg mx-auto flex gap-3">
            <button id="prev-btn" onclick="prevQuestion()"
                class="flex-1 py-3 px-4 rounded-xl border-2 border-gray-200 text-gray-600 font-semibold hover:bg-gray-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                ‚Üê Previous
            </button>
            <button id="next-btn" onclick="nextQuestion()"
                class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold shadow-lg shadow-emerald-500/30 hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                Next ‚Üí
            </button>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="results-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <div class="text-center">
                <div id="result-icon"
                    class="w-20 h-20 mx-auto mb-4 rounded-full bg-emerald-100 flex items-center justify-center">
                    <svg class="w-10 h-10 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Quiz Complete!</h2>
                <p class="text-gray-600 mb-4">Your Score</p>
                <p id="score-display" class="text-5xl font-bold text-emerald-600 mb-6">0%</p>
                <p id="score-detail" class="text-gray-500 mb-6">0 correct out of 0</p>
                <div class="space-y-3">
                    <a href="/daily/{{ subject.id }}/{{ date_code }}"
                        class="block w-full py-3 px-4 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50 transition-all">
                        üìñ Review Answers
                    </a>
                    <a href="/practice/{{ subject.id }}"
                        class="block w-full py-3 px-4 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold shadow-lg hover:shadow-xl transition-all">
                        ‚úì Done
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Quiz Data
    const questions = {{ questions | tojson | safe }};
    const totalQuestions = questions.length;
    let currentIndex = 0;
    let userAnswers = {};

    // Render current question
    function renderQuestion() {
        const q = questions[currentIndex];
        const selectedAnswer = userAnswers[q.id];

        let optionsHtml = '';
        q.options.forEach((opt, idx) => {
            const isSelected = selectedAnswer === idx;
            const letters = ['A', 'B', 'C', 'D'];
            optionsHtml += `
            <button onclick="selectAnswer(${idx})" 
                    class="w-full text-left p-4 rounded-xl border-2 transition-all ${isSelected
                    ? 'border-emerald-500 bg-emerald-50'
                    : 'border-gray-200 hover:border-emerald-300 hover:bg-emerald-50/50'
                }">
                <div class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-8 h-8 rounded-lg ${isSelected ? 'bg-emerald-500 text-white' : 'bg-gray-100 text-gray-600'
                } flex items-center justify-center font-bold text-sm">
                        ${letters[idx]}
                    </span>
                    <span class="text-gray-800 leading-relaxed">${opt}</span>
                </div>
            </button>
        `;
        });

        document.getElementById('question-container').innerHTML = `
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <p class="font-bold text-gray-800 text-lg leading-relaxed mb-6">${q.question}</p>
            <div class="space-y-3">
                ${optionsHtml}
            </div>
            ${q.year ? `
            <div class="mt-4 pt-3 border-t border-gray-100">
                <span class="inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">
                    ${q.year}
                </span>
            </div>
            ` : ''}
        </div>
    `;

        // Update UI
        document.getElementById('current-num').textContent = currentIndex + 1;
        document.getElementById('progress-bar').style.width = ((currentIndex + 1) / totalQuestions * 100) + '%';

        // Update buttons
        document.getElementById('prev-btn').disabled = currentIndex === 0;
        document.getElementById('next-btn').textContent = currentIndex === totalQuestions - 1 ? 'Submit ‚úì' : 'Next ‚Üí';
    }

    // Select answer
    function selectAnswer(idx) {
        const q = questions[currentIndex];
        userAnswers[q.id] = idx;
        renderQuestion();
    }

    // Navigation
    function prevQuestion() {
        if (currentIndex > 0) {
            currentIndex--;
            renderQuestion();
        }
    }

    function nextQuestion() {
        if (currentIndex < totalQuestions - 1) {
            currentIndex++;
            renderQuestion();
        } else {
            submitQuiz();
        }
    }

    // Submit quiz
    function submitQuiz() {
        // Calculate score
        let correct = 0;
        questions.forEach(q => {
            if (userAnswers[q.id] === q.correct) {
                correct++;
            }
        });

        const score = Math.round((correct / totalQuestions) * 100);

        // Show results
        document.getElementById('score-display').textContent = score + '%';
        document.getElementById('score-detail').textContent = `${correct} correct out of ${totalQuestions}`;

        // Update icon based on score
        const iconContainer = document.getElementById('result-icon');
        if (score >= 70) {
            iconContainer.className = 'w-20 h-20 mx-auto mb-4 rounded-full bg-emerald-100 flex items-center justify-center';
            iconContainer.innerHTML = '<svg class="w-10 h-10 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
        } else if (score >= 40) {
            iconContainer.className = 'w-20 h-20 mx-auto mb-4 rounded-full bg-yellow-100 flex items-center justify-center';
            iconContainer.innerHTML = '<svg class="w-10 h-10 text-yellow-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
        } else {
            iconContainer.className = 'w-20 h-20 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center';
            iconContainer.innerHTML = '<svg class="w-10 h-10 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
        }

        document.getElementById('results-modal').classList.remove('hidden');
        document.getElementById('results-modal').classList.add('flex');

        // Save to server
        fetch('/api/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                subject_id: '{{ subject.id }}',
                date_code: '{{ date_code }}',
                answers: userAnswers
            })
        });
    }

    // Confirm exit
    function confirmExit() {
        if (Object.keys(userAnswers).length > 0) {
            if (confirm('Are you sure you want to exit? Your progress will be lost.')) {
                window.location.href = '/daily/{{ subject.id }}/{{ date_code }}';
            }
        } else {
            window.location.href = '/daily/{{ subject.id }}/{{ date_code }}';
        }
    }

    // Initialize
    renderQuestion();
</script>
{% endblock %}